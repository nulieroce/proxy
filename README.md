# üöÄ ProxyRender Liberia

**Proxy reverso completo para Render.com** que oculta la IP y dominio de tu aplicaci√≥n original mientras captura informaci√≥n del cliente de forma transparente.

## üéØ Caracter√≠sticas Principales

- ‚úÖ **Ocultaci√≥n completa** de la IP y dominio del backend
- üåê **Captura de IP real** del usuario (`user_ip` header)
- üè† **Captura de dominio de acceso** (`domain_ip` header)
- üîÑ **Proxy transparente** para todas las peticiones (GET, POST, PUT, DELETE, etc.)
- üõ°Ô∏è **Rate limiting** configurable
- üíö **Anti-sleep** para plan gratuito de Render
- üîí **Headers de seguridad** b√°sicos
- ‚ö° **Compresi√≥n gzip** autom√°tica
- üìä **Health checks** y monitoreo
- üîç **Logging detallado** para debugging

## üìã Tabla de Contenidos

- [Instalaci√≥n Local](#-instalaci√≥n-local)
- [Configuraci√≥n](#-configuraci√≥n)
- [Deployment en Render](#-deployment-en-render)
- [Variables de Entorno](#-variables-de-entorno)
- [Endpoints Disponibles](#-endpoints-disponibles)
- [Testing](#-testing)
- [Monitoreo](#-monitoreo)
- [Troubleshooting](#-troubleshooting)
- [Contribuci√≥n](#-contribuci√≥n)

## üöÄ Instalaci√≥n Local

### Prerrequisitos

- Node.js >= 18.0.0
- npm o yarn
- Git

### Pasos

1. **Clonar el repositorio**
   ```bash
   git clone https://github.com/tu-usuario/proxyrender-liberia.git
   cd proxyrender-liberia
   ```

2. **Instalar dependencias**
   ```bash
   npm install
   ```

3. **Configurar variables de entorno**
   ```bash
   # Crear archivo .env (opcional para desarrollo)
   cp .env.example .env  # Si tienes archivo de ejemplo
   
   # O exportar directamente
   export TARGET_URL=https://tu-app-backend.com
   export NODE_ENV=development
   ```

4. **Ejecutar en modo desarrollo**
   ```bash
   npm run dev
   ```

5. **Ejecutar en modo producci√≥n**
   ```bash
   npm start
   ```

6. **Verificar funcionamiento**
   ```bash
   # Health check
   curl http://localhost:10000/health
   
   # Status del proxy
   curl http://localhost:10000/proxy-status
   ```

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno Requeridas

```bash
# URL del backend que se va a proxificar
TARGET_URL=https://tu-aplicacion-original.com

# Puerto del servicio (Render lo asigna autom√°ticamente)
PORT=10000

# Entorno de ejecuci√≥n
NODE_ENV=production
```

### Variables Opcionales

```bash
# Rate Limiting - Ventana de tiempo (15 min = 900000ms)
RATE_LIMIT_WINDOW_MS=900000

# Rate Limiting - M√°ximo peticiones por ventana
RATE_LIMIT_MAX_REQUESTS=100

# Keep-alive URL (para evitar sleep en plan gratuito)
KEEP_ALIVE_URL=https://tu-proxy.onrender.com
```

### Archivo .env de Ejemplo

```bash
# Configuraci√≥n principal
TARGET_URL=https://mi-app-original.com
NODE_ENV=development
PORT=10000

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Keep-alive (se configurar√° autom√°ticamente en Render)
KEEP_ALIVE_URL=https://tu-proxy.onrender.com
```

## üåü Deployment en Render

### M√©todo 1: Usando render.yaml (Recomendado)

1. **Conectar repositorio a Render**
   - Ve a [Render Dashboard](https://dashboard.render.com)
   - Click en "New" ‚Üí "Blueprint"
   - Conecta tu repositorio GitHub

2. **Configurar variables de entorno**
   ```bash
   TARGET_URL=https://tu-aplicacion-original.com
   # Las dem√°s se configuran autom√°ticamente
   ```

3. **Desplegar**
   - Render detectar√° autom√°ticamente el `render.yaml`
   - Se crear√° el servicio con toda la configuraci√≥n

### M√©todo 2: Manual

1. **Crear Web Service**
   - Dashboard ‚Üí New ‚Üí Web Service
   - Conectar repositorio

2. **Configuraci√≥n del servicio**
   ```
   Name: proxyrender-liberia
   Environment: Node
   Build Command: npm install
   Start Command: npm start
   ```

3. **Variables de entorno**
   ```
   TARGET_URL=https://tu-aplicacion-original.com
   NODE_ENV=production
   ```

4. **Configuraci√≥n adicional**
   ```
   Health Check Path: /health
   Auto-Deploy: Yes
   ```

### Configuraci√≥n Post-Deployment

Una vez desplegado, configura la URL de keep-alive:

1. Copia la URL de tu servicio (ej: `https://tu-proxy.onrender.com`)
2. Agrega la variable de entorno:
   ```bash
   KEEP_ALIVE_URL=https://tu-proxy.onrender.com
   ```

## üîß Variables de Entorno

| Variable | Tipo | Default | Descripci√≥n |
|----------|------|---------|-------------|
| `TARGET_URL` | **Requerida** | - | URL del backend a proxificar |
| `PORT` | Autom√°tica | 10000 | Puerto del servicio |
| `NODE_ENV` | Opcional | development | Entorno de ejecuci√≥n |
| `RATE_LIMIT_WINDOW_MS` | Opcional | 900000 | Ventana de rate limiting (ms) |
| `RATE_LIMIT_MAX_REQUESTS` | Opcional | 100 | Max peticiones por ventana |
| `KEEP_ALIVE_URL` | Opcional | - | URL para evitar sleep (plan gratuito) |

## üõ† Endpoints Disponibles

### Endpoints de Control

| Endpoint | M√©todo | Descripci√≥n | Respuesta |
|----------|--------|-------------|-----------|
| `/health` | GET | Health check del servicio | Status, uptime, memoria |
| `/keep-alive` | GET | Ping para evitar sleep | Status de actividad |
| `/proxy-status` | GET | Informaci√≥n del proxy | Config y cliente info |

### Proxy Transparente

- **Todas las dem√°s rutas** se reenv√≠an autom√°ticamente al `TARGET_URL`
- Se preservan m√©todos HTTP, headers, body, y query parameters
- Se agregan headers personalizados: `user_ip` y `domain_ip`

### Ejemplos de Uso

```bash
# Health check
curl https://tu-proxy.onrender.com/health

# Status del proxy
curl https://tu-proxy.onrender.com/proxy-status

# Petici√≥n que ser√° enviada al backend
curl https://tu-proxy.onrender.com/api/usuarios
# ‚Üí Se reenv√≠a a: https://tu-backend.com/api/usuarios
# ‚Üí Con headers: user_ip=x.x.x.x, domain_ip=tu-proxy.onrender.com
```

## üß™ Testing

### Health Check Manual

```bash
node health.js
```

### Health Check con URL personalizada

```bash
node health.js --url https://tu-proxy.onrender.com
```

### Health Check con opciones

```bash
node health.js --url https://tu-proxy.onrender.com --timeout 5000 --retries 5
```

### Testing con cURL

```bash
# Test b√°sico
curl -v https://tu-proxy.onrender.com/health

# Test con headers personalizados
curl -H \"User-Agent: Test-Client\" https://tu-proxy.onrender.com/proxy-status

# Test de rate limiting (hacer varias peticiones r√°pidas)
for i in {1..10}; do curl https://tu-proxy.onrender.com/health; done
```

### NPM Scripts

```bash
# Ejecutar health check
npm test

# Modo desarrollo con nodemon
npm run dev

# Producci√≥n
npm start
```

## üìä Monitoreo

### Logs Estructurados

El servicio genera logs detallados:

```
[2024-01-15T10:30:45.123Z] GET /api/users 200 - 45ms - IP: 192.168.1.1
[PROXY] GET /api/users -> https://backend.com/api/users
[PROXY] Added headers: user_ip=192.168.1.1, domain_ip=proxy.onrender.com
```

### M√©tricas Disponibles

- **Uptime**: Tiempo de actividad del servicio
- **Memory Usage**: Uso de memoria en tiempo real
- **Request Rate**: Peticiones por minuto
- **Response Time**: Tiempo de respuesta promedio
- **Error Rate**: Porcentaje de errores

### Health Check Autom√°tico

El servicio incluye un health check interno que verifica:

- ‚úÖ Conectividad con el backend
- ‚úÖ Estado de memoria
- ‚úÖ Tiempo de respuesta
- ‚úÖ Rate limiting funcional
- ‚úÖ Headers de seguridad

## üîç Headers Agregados

### Headers que se env√≠an al backend

```http
user_ip: 192.168.1.100          # IP real del cliente
domain_ip: tu-proxy.onrender.com # Dominio usado para acceder
X-Proxy-By: ProxyRender-Liberia # Identificador del proxy
User-Agent: Mozilla/5.0...      # User agent original preservado
```

### Headers que se remueven

```http
host                    # Se reemplaza por el target
server                  # Se oculta informaci√≥n del servidor
x-aspnet-version       # Se oculta informaci√≥n de framework
x-aspnetmvc-version    # Se oculta informaci√≥n de framework
```

### Headers que se agregan en la respuesta

```http
X-Powered-By: ProxyRender-Liberia
X-Proxy-Version: 1.0.0
```

## üõ°Ô∏è Caracter√≠sticas de Seguridad

### Rate Limiting

- **Ventana**: 15 minutos (configurable)
- **L√≠mite**: 100 peticiones por IP (configurable)
- **Respuesta**: HTTP 429 con mensaje explicativo

### Headers de Seguridad

```http
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
```

### Sanitizaci√≥n

- Headers sensibles removidos
- Informaci√≥n del servidor oculta
- Timeouts configurables
- Validaci√≥n de input b√°sica

## üö® Troubleshooting

### Problemas Comunes

#### 1. Error: ECONNREFUSED

```bash
Error: connect ECONNREFUSED
```

**Soluci√≥n**: Verificar que `TARGET_URL` sea correcta y est√© accesible.

```bash
# Verificar conectividad
curl -I https://tu-backend.com
```

#### 2. Rate Limiting Demasiado Agresivo

```bash
HTTP 429 - Too Many Requests
```

**Soluci√≥n**: Ajustar variables de rate limiting.

```bash
RATE_LIMIT_WINDOW_MS=1800000  # 30 minutos
RATE_LIMIT_MAX_REQUESTS=200   # 200 peticiones
```

#### 3. Sleep en Plan Gratuito

El servicio se duerme despu√©s de 30 minutos de inactividad.

**Soluci√≥n**: Configurar keep-alive.

```bash
KEEP_ALIVE_URL=https://tu-proxy.onrender.com
```

#### 4. Headers No Se Pasan

Los headers `user_ip` y `domain_ip` no llegan al backend.

**Soluci√≥n**: Verificar que tu backend los est√© leyendo correctamente.

```javascript
// En tu backend (Express)
app.use((req, res, next) => {
  console.log('User IP:', req.get('user_ip'));
  console.log('Domain:', req.get('domain_ip'));
  next();
});
```

### Debug Mode

Para debugging detallado:

```bash
NODE_ENV=development npm start
```

Esto habilitar√°:
- Logs detallados de cada petici√≥n
- Informaci√≥n de headers
- Tiempos de respuesta
- Stack traces completos

### Verificaci√≥n de Salud

```bash
# Verificar que el servicio est√° corriendo
curl https://tu-proxy.onrender.com/health

# Verificar configuraci√≥n del proxy
curl https://tu-proxy.onrender.com/proxy-status

# Verificar conectividad con backend
curl -I https://tu-backend.com
```

## üìà Optimizaci√≥n para Plan Gratuito

### Anti-Sleep

El sistema incluye un mecanismo autom√°tico que previene que Render duerma tu servicio:

```javascript
// Ping cada 10 minutos
cron.schedule('*/10 * * * *', () => {
  axios.get(KEEP_ALIVE_URL + '/keep-alive');
});
```

### Optimizaci√≥n de Recursos

- **Compresi√≥n gzip** para reducir bandwidth
- **Keep-alive connections** para reusar conexiones
- **Memory monitoring** para prevenir leaks
- **Request pooling** para optimizar peticiones

### Configuraci√≥n Recomendada para Free Tier

```bash
TARGET_URL=https://tu-backend.com
RATE_LIMIT_WINDOW_MS=900000      # 15 minutos
RATE_LIMIT_MAX_REQUESTS=50       # Conservador para free tier
KEEP_ALIVE_URL=https://tu-proxy.onrender.com  # ¬°IMPORTANTE!
NODE_ENV=production
```

## üîß Configuraci√≥n Avanzada

### Custom Headers

Para agregar headers personalizados:

```javascript
// En server.js, modificar onProxyReq
onProxyReq: (proxyReq, req, res) => {
  // Headers existentes
  proxyReq.setHeader('user_ip', getRealIP(req));
  proxyReq.setHeader('domain_ip', getAccessDomain(req));
  
  // Headers personalizados
  proxyReq.setHeader('X-Custom-Header', 'valor');
  proxyReq.setHeader('X-Request-ID', generateRequestId());
}
```

### Rate Limiting Personalizado

```javascript
// Rate limiting por ruta
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutos
  max: 100 // l√≠mite de 100 peticiones por IP
});

const strictLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5 // l√≠mite m√°s estricto
});

app.use('/api/', apiLimiter);
app.use('/admin/', strictLimiter);
```

### Middleware Personalizado

```javascript
// Agregar middleware personalizado antes del proxy
app.use((req, res, next) => {
  // L√≥gica personalizada
  req.customData = 'valor';
  next();
});
```

## üìã Ejemplo de Implementaci√≥n Completa

### Backend (Express.js)

```javascript
// En tu aplicaci√≥n backend
app.use((req, res, next) => {
  // Leer los headers del proxy
  const clientIP = req.get('user_ip');
  const accessDomain = req.get('domain_ip');
  
  console.log(`Cliente real: ${clientIP} desde dominio: ${accessDomain}`);
  
  // Usar en tu l√≥gica de negocio
  req.realClientIP = clientIP;
  req.accessDomain = accessDomain;
  
  next();
});
```

### Frontend (cualquier tecnolog√≠a)

```javascript
// El frontend no necesita cambios
// Todas las peticiones van normalmente al proxy

fetch('https://tu-proxy.onrender.com/api/users')
  .then(response => response.json())
  .then(data => console.log(data));

// La petici√≥n ser√° autom√°ticamente enviada a:
// https://tu-backend.com/api/users
// Con headers: user_ip=x.x.x.x, domain_ip=tu-proxy.onrender.com
```

## üèóÔ∏è Arquitectura

```
[Cliente] ‚Üí [Render Proxy] ‚Üí [Tu Backend]
    ‚Üì           ‚Üì                ‚Üì
  IP Real   Captura IP      Recibe Headers:
            Captura Domain   - user_ip
            Agrega Headers   - domain_ip
            Rate Limiting    - X-Proxy-By
            Seguridad
```

### Flujo de Datos

1. **Cliente** hace petici√≥n a `https://tu-proxy.onrender.com/api/data`
2. **Proxy** captura IP real y dominio de acceso
3. **Proxy** agrega headers `user_ip` y `domain_ip`
4. **Proxy** reenv√≠a petici√≥n a `https://tu-backend.com/api/data`
5. **Backend** procesa con informaci√≥n real del cliente
6. **Backend** responde a proxy
7. **Proxy** reenv√≠a respuesta al cliente

## ü§ù Contribuci√≥n

### Reportar Issues

Si encuentras alg√∫n problema:

1. Describe el problema claramente
2. Incluye logs relevantes
3. Especifica tu configuraci√≥n
4. Proporciona pasos para reproducir

### Pull Requests

1. Fork el repositorio
2. Crea una rama para tu feature (`git checkout -b feature/nueva-funcionalidad`)
3. Commit tus cambios (`git commit -m 'Add nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Abre un Pull Request

### Desarrollo Local

```bash
# Clonar tu fork
git clone https://github.com/tu-usuario/proxyrender-liberia.git

# Instalar dependencias
npm install

# Ejecutar en modo desarrollo
npm run dev

# Ejecutar tests
npm test
```

## üìù Notas Importantes

### ‚ö†Ô∏è Consideraciones de Seguridad

- **Nunca expongas** informaci√≥n sensible en los logs
- **Valida siempre** las URLs del `TARGET_URL`
- **Usa HTTPS** tanto en el proxy como en el backend
- **Revisa regularmente** los headers que se pasan

### üí° Best Practices

- **Monitorea** regularmente el uso de recursos
- **Implementa** logging estructurado
- **Usa** environment variables para toda configuraci√≥n
- **Mant√©n** el proxy lo m√°s simple posible
- **Documenta** cualquier customizaci√≥n

### üîÑ Actualizaciones

Para mantener el proxy actualizado:

```bash
# Verificar actualizaciones de dependencias
npm audit

# Actualizar dependencias
npm update

# Verificar funcionamiento
npm test
```

## üìû Soporte

Si necesitas ayuda:

- üìß Email: tu-email@ejemplo.com
- üêõ Issues: [GitHub Issues](https://github.com/tu-usuario/proxyrender-liberia/issues)
- üìñ Docs: [Wiki del Proyecto](https://github.com/tu-usuario/proxyrender-liberia/wiki)

---

## üìÑ Licencia

MIT License - ver [LICENSE](LICENSE) para m√°s detalles.

---

<div align="center">

**‚≠ê Si este proyecto te fue √∫til, dale una estrella en GitHub ‚≠ê**

Hecho con ‚ù§Ô∏è para la comunidad de desarrolladores

</div>